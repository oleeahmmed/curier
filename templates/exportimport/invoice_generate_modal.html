<!-- Modal content only (no wrapper) -->
<form method="post" id="invoiceGenerateForm" action="{% url 'invoice_generate' shipment.id %}">
    {% csrf_token %}
    
    <!-- Shipper and Consignee in 2 columns - More Compact -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
        <!-- Shipper Column -->
        <div>
            <h3 class="text-xs font-semibold text-gray-700 mb-2">Shipper</h3>
            
            <div class="mb-2">
                <label class="block text-xs text-gray-500 mb-1">Name <span class="text-red-500">*</span></label>
                {{ form.shipper_name }}
            </div>
            
            <div>
                <label class="block text-xs text-gray-500 mb-1">Address <span class="text-red-500">*</span></label>
                {{ form.shipper_address }}
            </div>
        </div>
        
        <!-- Consignee Column -->
        <div>
            <h3 class="text-xs font-semibold text-gray-700 mb-2">Consignee</h3>
            
            <div class="mb-2">
                <label class="block text-xs text-gray-500 mb-1">Name <span class="text-red-500">*</span></label>
                {{ form.consignee_name }}
            </div>
            
            <div>
                <label class="block text-xs text-gray-500 mb-1">Address <span class="text-red-500">*</span></label>
                {{ form.consignee_address }}
            </div>
        </div>
    </div>
    
    <!-- Product Line Items - More Compact -->
    <div class="mb-4">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-xs font-semibold text-gray-700">Products</h3>
            <button type="button" id="addInvoiceItemBtn" class="text-xs text-blue-600 hover:text-blue-700 font-medium">+ Add</button>
        </div>
        
        {{ formset.management_form }}
        
        <div id="invoiceItemsContainer" class="space-y-2">
            <div class="invoice-item-row border border-gray-200 rounded-md p-2 bg-white" data-index="0">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs text-gray-600 font-medium">Item 1</span>
                </div>
                
                <div class="grid grid-cols-12 gap-2">
                    <div class="col-span-12">
                        <input type="text" name="form-0-description" placeholder="Description" class="w-full text-xs border border-gray-300 rounded px-2 py-1.5 bg-gray-100 focus:bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" required>
                    </div>
                    <div class="col-span-4">
                        <input type="number" step="0.01" name="form-0-weight" placeholder="Weight (kg)" class="w-full text-xs border border-gray-300 rounded px-2 py-1.5 bg-gray-100 focus:bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" required>
                    </div>
                    <div class="col-span-4">
                        <input type="number" name="form-0-quantity" placeholder="Qty" class="w-full text-xs border border-gray-300 rounded px-2 py-1.5 bg-gray-100 focus:bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" required>
                    </div>
                    <div class="col-span-4">
                        <input type="number" step="0.01" name="form-0-unit_value" placeholder="Value ({{ shipment.declared_currency }})" class="w-full text-xs border border-gray-300 rounded px-2 py-1.5 bg-gray-100 focus:bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" required>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="invoiceFormErrors" class="hidden mb-3 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-600"></div>
    
    <div class="flex gap-2">
        <button type="submit" class="flex-1 px-3 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded transition-colors">
            Generate Invoice
        </button>
        <button type="button" onclick="closeModal('invoiceGenerateModal')" class="flex-1 px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 rounded transition-colors">
            Cancel
        </button>
    </div>
</form>

<script>
(function() {
    console.log('Invoice modal script loaded');
    
    const form = document.getElementById('invoiceGenerateForm');
    const container = document.getElementById('invoiceItemsContainer');
    const addBtn = document.getElementById('addInvoiceItemBtn');
    const totalForms = document.querySelector('[name$="-TOTAL_FORMS"]');
    
    if (!form || !container || !addBtn || !totalForms) {
        console.error('Invoice form elements not found');
        return;
    }
    
    // Set initial count to 1
    totalForms.value = 1;
    let itemCount = 1;
    
    console.log('Invoice form initialized');
    
    // Add item button
    addBtn.onclick = function(e) {
        e.preventDefault();
        console.log('Add item clicked, current count:', itemCount);
        
        const newItem = document.createElement('div');
        newItem.className = 'invoice-item-row border border-gray-200 rounded-md p-2 bg-white';
        newItem.setAttribute('data-index', itemCount);
        
        newItem.innerHTML = `
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs text-gray-600 font-medium">Item ${itemCount + 1}</span>
                <button type="button" class="remove-invoice-item text-xs text-red-500 hover:text-red-600">Remove</button>
            </div>
            
            <div class="grid grid-cols-12 gap-2">
                <div class="col-span-12">
                    <input type="text" name="form-${itemCount}-description" placeholder="Description" class="w-full text-xs border border-gray-300 rounded px-2 py-1.5 bg-gray-100 focus:bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" required>
                </div>
                <div class="col-span-4">
                    <input type="number" step="0.01" name="form-${itemCount}-weight" placeholder="Weight (kg)" class="w-full text-xs border border-gray-300 rounded px-2 py-1.5 bg-gray-100 focus:bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" required>
                </div>
                <div class="col-span-4">
                    <input type="number" name="form-${itemCount}-quantity" placeholder="Qty" class="w-full text-xs border border-gray-300 rounded px-2 py-1.5 bg-gray-100 focus:bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" required>
                </div>
                <div class="col-span-4">
                    <input type="number" step="0.01" name="form-${itemCount}-unit_value" placeholder="Value ({{ shipment.declared_currency }})" class="w-full text-xs border border-gray-300 rounded px-2 py-1.5 bg-gray-100 focus:bg-white focus:outline-none focus:ring-1 focus:ring-blue-500" required>
                </div>
            </div>
        `;
        
        container.appendChild(newItem);
        itemCount++;
        totalForms.value = itemCount;
        
        console.log('Item added, new count:', itemCount);
    };
    
    // Remove item (event delegation)
    container.onclick = function(e) {
        if (e.target.classList.contains('remove-invoice-item')) {
            e.preventDefault();
            console.log('Remove item clicked');
            
            const items = container.querySelectorAll('.invoice-item-row');
            if (items.length > 1) {
                e.target.closest('.invoice-item-row').remove();
                itemCount--;
                totalForms.value = itemCount;
                
                console.log('Item removed, new count:', itemCount);
                
                // Renumber items
                container.querySelectorAll('.invoice-item-row').forEach((item, idx) => {
                    item.setAttribute('data-index', idx);
                    const label = item.querySelector('.text-xs.text-gray-600.font-medium');
                    if (label) label.textContent = 'Item ' + (idx + 1);
                    
                    // Update field names
                    item.querySelectorAll('input').forEach(field => {
                        const name = field.getAttribute('name');
                        if (name) {
                            const fieldType = name.split('-').pop();
                            field.setAttribute('name', `form-${idx}-${fieldType}`);
                        }
                    });
                    
                    // Remove "Remove" button from first item
                    if (idx === 0) {
                        const removeBtn = item.querySelector('.remove-invoice-item');
                        if (removeBtn) removeBtn.remove();
                    }
                });
            }
        }
    };
    
    // Form submission
    form.onsubmit = function(e) {
        e.preventDefault();
        console.log('Form submitted');
        
        const formData = new FormData(form);
        const errorDiv = document.getElementById('invoiceFormErrors');
        
        // Hide previous errors
        errorDiv.classList.add('hidden');
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Response:', data);
            if (data.success) {
                closeModal('invoiceGenerateModal');
                if (typeof showToast === 'function') {
                    showToast('Invoice generated successfully', 'success');
                }
                setTimeout(() => location.reload(), 1000);
            } else {
                errorDiv.textContent = data.error || 'Error generating invoice';
                errorDiv.classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            errorDiv.textContent = 'Error: ' + error.message;
            errorDiv.classList.remove('hidden');
        });
    };
})();
</script>
