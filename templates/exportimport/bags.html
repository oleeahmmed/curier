{% extends 'exportimport/base.html' %}

{% block title %}Bag Management{% endblock %}
{% block page_title %}Bag Management{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<style>
    #modalReader { 
        width: 100% !important; 
        max-width: 300px;
        margin: 0 auto;
    }
    #modalReader video { 
        border-radius: 8px; 
        width: 100% !important; 
        max-height: 200px;
        object-fit: cover;
    }
</style>
{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
    <div class="card">
        <div class="card-body p-3">
            <p class="text-xs text-gray-500 mb-1">Total Bags</p>
            <p class="text-xl font-bold text-gray-900">{{ total_bags }}</p>
        </div>
    </div>
    <div class="card">
        <div class="card-body p-3">
            <p class="text-xs text-gray-500 mb-1">Open</p>
            <p class="text-xl font-bold text-blue-600">{{ open_bags }}</p>
        </div>
    </div>
    <div class="card">
        <div class="card-body p-3">
            <p class="text-xs text-gray-500 mb-1">Sealed</p>
            <p class="text-xl font-bold text-green-600">{{ sealed_bags }}</p>
        </div>
    </div>
    <div class="card">
        <div class="card-body p-3">
            <p class="text-xs text-gray-500 mb-1">Dispatched</p>
            <p class="text-xl font-bold text-gray-600">{{ dispatched_bags }}</p>
        </div>
    </div>
</div>

<!-- Filters and Create Button -->
<div class="card mb-4">
    <div class="card-body p-3">
        <form method="GET" action="{% url 'bags' %}" class="space-y-3">
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Search -->
                <div class="flex-1">
                    <label class="text-xs text-gray-500 mb-1 block">Search Bag Number</label>
                    <input 
                        type="text" 
                        name="search" 
                        value="{{ search }}"
                        placeholder="Enter bag number..."
                        class="form-input w-full"
                    >
                </div>
                
                <!-- Status Filter -->
                <div class="w-full md:w-48">
                    <label class="text-xs text-gray-500 mb-1 block">Status</label>
                    <select name="status" class="form-input w-full">
                        <option value="">All Statuses</option>
                        {% for status_code, status_label in status_choices %}
                        <option value="{{ status_code }}" {% if status_filter == status_code %}selected{% endif %}>
                            {{ status_label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Date From -->
                <div class="w-full md:w-40">
                    <label class="text-xs text-gray-500 mb-1 block">From Date</label>
                    <input 
                        type="date" 
                        name="date_from" 
                        value="{{ date_from }}"
                        class="form-input w-full"
                    >
                </div>
                
                <!-- Date To -->
                <div class="w-full md:w-40">
                    <label class="text-xs text-gray-500 mb-1 block">To Date</label>
                    <input 
                        type="date" 
                        name="date_to" 
                        value="{{ date_to }}"
                        class="form-input w-full"
                    >
                </div>
            </div>
            
            <div class="flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    Apply Filters
                </button>
                <a href="{% url 'bags' %}" class="btn btn-secondary">
                    Clear Filters
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Create Bag Button & MAWB Search -->
<div class="mb-4 flex flex-col md:flex-row gap-3">
    <button onclick="showCreateModal()" class="btn btn-primary flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        <span>Create New Bag</span>
    </button>
    <button onclick="showMAWBSearchModal()" class="btn btn-secondary flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <span>Search Manifest by MAWB</span>
    </button>
</div>

<!-- Bags List -->
<div class="card">
    <div class="card-body">
        {% if bags %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                            <a href="?search={{ search }}&status={{ status_filter }}&date_from={{ date_from }}&date_to={{ date_to }}&sort={% if sort_by == 'bag_number' %}-bag_number{% else %}bag_number{% endif %}" class="hover:text-gray-700">
                                Bag Number
                                {% if sort_by == 'bag_number' %}‚Üë{% elif sort_by == '-bag_number' %}‚Üì{% endif %}
                            </a>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                            <a href="?search={{ search }}&status={{ status_filter }}&date_from={{ date_from }}&date_to={{ date_to }}&sort={% if sort_by == 'status' %}-status{% else %}status{% endif %}" class="hover:text-gray-700">
                                Status
                                {% if sort_by == 'status' %}‚Üë{% elif sort_by == '-status' %}‚Üì{% endif %}
                            </a>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Item Count</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                            <a href="?search={{ search }}&status={{ status_filter }}&date_from={{ date_from }}&date_to={{ date_to }}&sort={% if sort_by == 'weight' %}-weight{% else %}weight{% endif %}" class="hover:text-gray-700">
                                Total Weight
                                {% if sort_by == 'weight' %}‚Üë{% elif sort_by == '-weight' %}‚Üì{% endif %}
                            </a>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created By</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                            <a href="?search={{ search }}&status={{ status_filter }}&date_from={{ date_from }}&date_to={{ date_to }}&sort={% if sort_by == 'created_at' %}-created_at{% else %}created_at{% endif %}" class="hover:text-gray-700">
                                Created At
                                {% if sort_by == 'created_at' %}‚Üë{% elif sort_by == '-created_at' %}‚Üì{% endif %}
                            </a>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sealed At</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for bag in bags %}
                    <tr class="{% if forloop.counter0|divisibleby:2 %}bg-gray-100{% else %}bg-white{% endif %} hover:bg-gray-200 cursor-pointer" onclick="window.location.href='{% url 'bag_detail' bag.id %}'"></tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">{{ bag.bag_number }}</td>
                        <td class="px-4 py-3">
                            <span class="status-badge {% if bag.status == 'OPEN' %}status-pending{% elif bag.status == 'SEALED' %}status-booked{% elif bag.status == 'DISPATCHED' %}status-delivered{% else %}status-transit{% endif %} text-xs">
                                {{ bag.get_status_display }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ bag.get_item_count }}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ bag.weight }} KG</td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            {% if bag.created_by %}
                                {{ bag.created_by.get_full_name|default:bag.created_by.username }}
                            {% else %}
                                <span class="text-gray-400 italic">N/A</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ bag.created_at|date:"M d, Y H:i" }}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            {% if bag.sealed_at %}
                                {{ bag.sealed_at|date:"M d, Y H:i" }}
                            {% else %}
                                <span class="text-gray-400 italic">-</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex gap-2" onclick="event.stopPropagation();">
                                <a href="{% url 'bag_detail' bag.id %}" class="text-xs px-3 py-1.5 bg-black text-white border border-black hover:bg-gray-800 rounded font-medium transition-colors">
                                    View
                                </a>
                                <button onclick="printBagLabel({{ bag.id }})" class="text-xs px-3 py-1.5 bg-blue-600 text-white border border-black hover:bg-blue-700 rounded font-medium transition-colors">
                                    Print Label
                                </button>
                                {% if bag.status == 'SEALED' and bag.air_invoice %}
                                <a href="{% url 'download_air_invoice' bag.id %}" target="_blank" class="text-xs px-3 py-1.5 bg-green-600 text-white border border-black hover:bg-green-700 rounded font-medium transition-colors">
                                    Download Invoice
                                </a>
                                {% endif %}
                                {% if bag.status == 'OPEN' %}
                                <button onclick="deleteBag({{ bag.id }}, '{{ bag.bag_number }}')" class="text-xs px-3 py-1.5 bg-red-600 text-white border border-black hover:bg-red-700 rounded font-medium transition-colors">
                                    Delete
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <!-- Empty State -->
        <div class="text-center py-12">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                </svg>
            </div>
            <p class="text-sm font-medium text-gray-900 mb-1">No bags found</p>
            <p class="text-xs text-gray-500 mb-4">
                {% if search or status_filter or date_from or date_to %}
                    Try adjusting your filters or create a new bag
                {% else %}
                    Create your first bag to get started
                {% endif %}
            </p>
            <button onclick="showCreateModal()" class="btn btn-primary">
                Create Bag
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Create Bag Modal -->
<div id="createBagModal" class="modal">
    <div class="modal-content max-w-md">
        <div class="sticky top-0 bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between z-10">
            <button onclick="hideModal('createBagModal')" class="p-2 -ml-2 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <h3 class="text-base font-semibold text-gray-900">Create New Bag</h3>
            <div class="w-10"></div>
        </div>
        
        <div class="p-4 space-y-4">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <p class="text-sm text-blue-800">
                    ‚ÑπÔ∏è Bag number will be auto-generated when you create the bag
                </p>
            </div>

            <div class="form-group">
                <label class="form-label text-sm font-medium">Shipments (Optional)</label>
                <div id="selectedShipmentsList" class="mb-2 space-y-1">
                    <!-- Selected shipments will appear here -->
                </div>
                <button type="button" onclick="showShipmentScanModal()" class="w-full btn btn-secondary py-2 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add Shipment
                </button>
                <p class="text-xs text-gray-500 mt-1">You can add multiple shipments to this bag</p>
                <input type="hidden" id="selectedShipmentIds" value="">
            </div>

            <div class="form-group">
                <label class="form-label text-sm font-medium">Weight (KG)</label>
                <input 
                    type="number" 
                    id="bagWeight"
                    placeholder="0.00"
                    step="0.01"
                    min="0"
                    class="form-input"
                >
            </div>

            <div class="flex gap-3 pt-2">
                <button onclick="hideModal('createBagModal')" class="flex-1 btn btn-secondary py-3">
                    Cancel
                </button>
                <button onclick="createBag()" class="flex-1 btn btn-primary py-3">
                    Create Bag
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Bag Details Modal -->
<div id="viewBagModal" class="modal">
    <div class="modal-content max-w-2xl">
        <div class="sticky top-0 bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between z-10">
            <button onclick="hideModal('viewBagModal')" class="p-2 -ml-2 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <h3 class="text-base font-semibold text-gray-900">Bag Details</h3>
            <div class="w-10"></div>
        </div>
        
        <div class="max-h-[85vh] overflow-y-auto">
            <!-- Bag Info -->
            <div class="bg-white p-4 border-b border-gray-100">
                <div class="text-center mb-4">
                    <p class="text-xs text-gray-500 mb-1">Bag Number</p>
                    <p class="text-xl font-bold text-gray-900" id="viewBagNumber"></p>
                </div>
                
                <div class="flex items-center justify-center mb-4">
                    <span id="viewBagStatus" class="status-badge text-sm px-4 py-2"></span>
                </div>
                
                <div class="grid grid-cols-2 gap-3 text-sm bg-gray-50 rounded-lg p-3">
                    <div>
                        <p class="text-xs text-gray-500 mb-1">Weight</p>
                        <p class="font-medium text-gray-900 text-sm" id="viewBagWeight"></p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 mb-1">Created</p>
                        <p class="font-medium text-gray-900 text-sm" id="viewBagCreated"></p>
                    </div>
                    <div class="col-span-2" id="viewBagShipmentContainer">
                        <p class="text-xs text-gray-500 mb-1">Shipment</p>
                        <p class="font-medium text-gray-900 text-sm" id="viewBagShipment"></p>
                    </div>
                </div>
                
                <!-- Shipment & Manifest Info -->
                <div id="shipmentManifestInfo" class="mt-3 space-y-2 hidden">
                    <div id="shipmentDetailSection" class="bg-green-50 rounded-lg p-3 border border-green-200 hidden">
                        <p class="text-xs text-green-600 font-semibold mb-1">üì¶ Shipment Details</p>
                        <p class="text-sm font-medium text-gray-900" id="viewShipmentAwb"></p>
                        <p class="text-xs text-gray-600" id="viewShipmentRecipient"></p>
                        <p class="text-xs text-gray-600" id="viewShipmentStatus"></p>
                    </div>
                    <div id="manifestDetailSection" class="bg-purple-50 rounded-lg p-3 border border-purple-200 hidden">
                        <p class="text-xs text-purple-600 font-semibold mb-1">‚úàÔ∏è Manifest Details</p>
                        <p class="text-sm font-medium text-gray-900" id="viewManifestNum"></p>
                        <p class="text-xs text-gray-600" id="viewManifestFlight"></p>
                        <p class="text-xs text-gray-600" id="viewManifestStatus"></p>
                    </div>
                </div>
            </div>

            <!-- Status Actions -->
            <div class="bg-white p-4 border-b border-gray-100" id="statusActionsContainer">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Change Status</h3>
                <div id="statusActionBtns" class="space-y-2"></div>
            </div>

            <!-- QR & Barcode -->
            <div class="bg-white p-4">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Shipment Codes</h3>
                <p class="text-xs text-gray-500 mb-3" id="codesNote">Displaying shipment AWB codes</p>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <p class="text-xs text-gray-500 mb-2">QR Code</p>
                        <img id="viewBagQR" src="" alt="QR Code" class="mx-auto border border-gray-200 rounded">
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 mb-2">Barcode</p>
                        <img id="viewBagBarcode" src="" alt="Barcode" class="mx-auto border border-gray-200 rounded">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Shipment Scan/Input Modal -->
<div id="shipmentScanModal" class="modal">
    <div class="modal-content max-w-md">
        <div class="sticky top-0 bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between z-10">
            <button onclick="hideModal('shipmentScanModal')" class="p-2 -ml-2 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <h3 class="text-base font-semibold text-gray-900">Find Shipment</h3>
            <div class="w-10"></div>
        </div>
        
        <div class="p-4 space-y-4 max-h-[80vh] overflow-y-auto">
            <!-- Scanner Section -->
            <div class="form-group">
                <label class="form-label text-sm font-medium">Scan QR/Barcode</label>
                <div class="bg-gray-50 rounded-lg p-4 border-2 border-dashed border-gray-300">
                    <div id="modalReader" class="bg-white rounded-lg" style="max-width: 300px; margin: 0 auto;"></div>
                    <button id="startModalScan" onclick="startModalScanner()" class="w-full mt-3 btn btn-primary text-sm">
                        Start Scanner
                    </button>
                    <button id="stopModalScan" onclick="stopModalScanner()" class="w-full mt-3 btn btn-secondary text-sm hidden">
                        Stop Scanner
                    </button>
                </div>
            </div>

            <!-- Or Divider -->
            <div class="relative my-4">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-xs">
                    <span class="px-2 bg-white text-gray-500">OR</span>
                </div>
            </div>

            <!-- Manual Input -->
            <div class="form-group">
                <label class="form-label text-sm font-medium">Enter AWB Number</label>
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="manualAwbInput"
                        placeholder="e.g., DH202501291234"
                        class="form-input flex-1"
                        onkeypress="if(event.key==='Enter') searchShipmentByAwb()"
                    >
                    <button onclick="searchShipmentByAwb()" class="btn btn-primary px-4">
                        Search
                    </button>
                </div>
            </div>

            <!-- Shipment Info (shown after search) -->
            <div id="shipmentInfo" class="hidden">
                <div class="bg-green-50 rounded-lg p-3 border border-green-200">
                    <p class="text-xs text-green-600 mb-1">‚úì Shipment Found</p>
                    <p class="text-sm font-semibold text-gray-900" id="foundAwb"></p>
                    <p class="text-xs text-gray-600 mt-1" id="foundRecipient"></p>
                    <p class="text-xs text-gray-600" id="foundWeight"></p>
                    <p class="text-xs text-gray-600" id="foundStatus"></p>
                </div>
                <button onclick="selectFoundShipment()" class="w-full btn btn-success mt-3">
                    Select This Shipment
                </button>
            </div>

            <!-- Or Divider -->
            <div class="relative my-4">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-xs">
                    <span class="px-2 bg-white text-gray-500">OR</span>
                </div>
            </div>

            <!-- All Non-Delivered Shipments Dropdown -->
            <div class="form-group">
                <label class="form-label text-sm font-medium">Select from All Shipments</label>
                <select id="allShipmentsDropdown" class="form-input" onchange="selectFromDropdown()">
                    <option value="">Choose a shipment...</option>
                    {% for shipment in all_shipments %}
                    <option value="{{ shipment.id }}" 
                            data-awb="{{ shipment.awb_number }}" 
                            data-recipient="{{ shipment.recipient_name }}" 
                            data-weight="{{ shipment.weight_estimated }}"
                            data-status="{{ shipment.get_current_status_display }}">
                        {{ shipment.awb_number }} - {{ shipment.recipient_name }} ({{ shipment.get_current_status_display }})
                    </option>
                    {% endfor %}
                </select>
                <p class="text-xs text-gray-500 mt-1">Showing all non-delivered shipments</p>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Status Change Modal -->
<div id="confirmStatusModal" class="modal">
    <div class="modal-content max-w-md">
        <div class="p-5">
            <div class="text-center mb-4">
                <div class="w-12 h-12 bg-black rounded-full flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h3 class="text-base font-semibold text-gray-900 mb-2">Confirm Status Change</h3>
                <p class="text-sm text-gray-600">Are you sure you want to change the bag status to <span id="confirmNewStatus" class="font-semibold text-gray-900"></span>?</p>
            </div>
            <div class="flex gap-3">
                <button onclick="hideModal('confirmStatusModal')" class="flex-1 btn btn-secondary py-3">
                    Cancel
                </button>
                <button id="confirmStatusBtn" class="flex-1 btn btn-primary py-3">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Bag Confirmation Modal -->
<div id="deleteBagModal" class="modal">
    <div class="modal-content max-w-md">
        <div class="p-5">
            <div class="text-center mb-4">
                <div class="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </div>
                <h3 class="text-base font-semibold text-gray-900 mb-2">Delete Bag</h3>
                <p class="text-sm text-gray-600 mb-2">Are you sure you want to delete bag <span id="deleteBagNumber" class="font-semibold text-gray-900"></span>?</p>
                <p class="text-sm text-red-600">This will remove all parcels from the bag and return them to RECEIVED_AT_BD status.</p>
            </div>
            <div class="flex gap-3">
                <button onclick="hideModal('deleteBagModal')" class="flex-1 btn btn-secondary py-3">
                    Cancel
                </button>
                <button id="confirmDeleteBtn" class="flex-1 btn btn-danger py-3">
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MAWB Search Modal -->
<div id="mawbSearchModal" class="modal">
    <div class="modal-content max-w-2xl">
        <div class="sticky top-0 bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between z-10">
            <button onclick="hideModal('mawbSearchModal')" class="p-2 -ml-2 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <h3 class="text-base font-semibold text-gray-900">Search Manifest by MAWB</h3>
            <div class="w-10"></div>
        </div>
        
        <div class="p-4 space-y-4 max-h-[85vh] overflow-y-auto">
            <!-- Search Input -->
            <div class="form-group">
                <label class="form-label text-sm font-medium">Enter MAWB Number</label>
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="mawbSearchInput"
                        placeholder="e.g., 123-45678901"
                        class="form-input flex-1"
                        onkeypress="if(event.key==='Enter') searchByMAWB()"
                    >
                    <button onclick="searchByMAWB()" class="btn btn-primary px-6">
                        Search
                    </button>
                </div>
            </div>

            <!-- Search Results -->
            <div id="mawbSearchResults" class="hidden">
                <!-- Manifest Info Card -->
                <div class="bg-white border-2 border-gray-200 rounded-lg p-4">
                    <div class="text-center mb-4">
                        <p class="text-xs text-gray-500 mb-1">Manifest Number</p>
                        <p class="text-xl font-bold text-gray-900" id="mawbManifestNumber"></p>
                    </div>
                    
                    <div class="flex items-center justify-center mb-4">
                        <span id="mawbManifestStatus" class="status-badge text-sm px-4 py-2"></span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 text-sm bg-gray-50 rounded-lg p-3">
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Flight</p>
                            <p class="font-medium text-gray-900 text-sm" id="mawbFlight"></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">MAWB</p>
                            <p class="font-medium text-gray-900 text-sm" id="mawbNumber"></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Departure</p>
                            <p class="font-medium text-gray-900 text-sm" id="mawbDeparture"></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Total Bags</p>
                            <p class="font-medium text-gray-900 text-sm" id="mawbTotalBags"></p>
                        </div>
                    </div>
                </div>

                <!-- Status Update Actions -->
                <div id="mawbStatusActions" class="mt-4">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3">Update Manifest Status</h3>
                    <div id="mawbActionButtons" class="space-y-2"></div>
                </div>

                <!-- View Details Button -->
                <div class="mt-4">
                    <a id="mawbViewDetailsLink" href="#" class="w-full btn btn-secondary py-3 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        <span>View Full Manifest Details</span>
                    </a>
                </div>
            </div>

            <!-- Not Found Message -->
            <div id="mawbNotFound" class="hidden">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                    <svg class="w-12 h-12 text-yellow-600 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <p class="text-sm font-medium text-gray-900 mb-1">Manifest Not Found</p>
                    <p class="text-xs text-gray-600">No manifest found with the provided MAWB number</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Manifest Status Update Modal -->
<div id="confirmManifestStatusModal" class="modal">
    <div class="modal-content max-w-md">
        <div class="p-5">
            <div class="text-center mb-4">
                <div class="w-12 h-12 bg-black rounded-full flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h3 class="text-base font-semibold text-gray-900 mb-2">Confirm Status Update</h3>
                <p class="text-sm text-gray-600">Are you sure you want to update the manifest status to <span id="confirmManifestNewStatus" class="font-semibold text-gray-900"></span>?</p>
            </div>
            <div class="flex gap-3">
                <button onclick="hideModal('confirmManifestStatusModal')" class="flex-1 btn btn-secondary py-3">
                    Cancel
                </button>
                <button id="confirmManifestStatusBtn" class="flex-1 btn btn-primary py-3">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Show create modal
let selectedShipments = [];
function showCreateModal() {
    selectedShipments = [];
    document.getElementById('selectedShipmentsList').innerHTML = '';
    document.getElementById('selectedShipmentIds').value = '';
    document.getElementById('bagWeight').value = '';
    showModal('createBagModal');
}

// Print bag label
function printBagLabel(bagId) {
    // Open print label page in new window
    window.open(`/bags/${bagId}/label/`, '_blank');
}

// Delete bag - show confirmation modal
let pendingDeleteBagId = null;
function deleteBag(bagId, bagNumber) {
    pendingDeleteBagId = bagId;
    document.getElementById('deleteBagNumber').textContent = bagNumber;
    showModal('deleteBagModal');
}

// Confirm delete bag
document.getElementById('confirmDeleteBtn').onclick = async function() {
    if (!pendingDeleteBagId) return;
    
    hideModal('deleteBagModal');
    showLoading();
    
    try {
        const response = await fetch(`/bags/${pendingDeleteBagId}/delete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        hideLoading();
        
        if (data.success) {
            toast('‚úì Bag deleted successfully');
            setTimeout(() => location.reload(), 1000);
        } else {
            toast('Error: ' + data.error);
        }
    } catch (err) {
        hideLoading();
        toast('Request failed');
    }
    
    pendingDeleteBagId = null;
};

// Modal scanner variables
let modalQrScanner = null;
let modalScanning = false;

// Show shipment scan modal
function showShipmentScanModal() {
    document.getElementById('manualAwbInput').value = '';
    document.getElementById('shipmentInfo').classList.add('hidden');
    document.getElementById('allShipmentsDropdown').value = '';
    showModal('shipmentScanModal');
}

// Start modal scanner
async function startModalScanner() {
    if (modalScanning) return;
    
    try {
        modalScanning = true;
        modalQrScanner = new Html5Qrcode("modalReader");
        
        await modalQrScanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 200 },
            (decodedText) => {
                document.getElementById('manualAwbInput').value = decodedText;
                searchShipmentByAwb();
                stopModalScanner();
            },
            () => {}
        );
        
        document.getElementById('startModalScan').classList.add('hidden');
        document.getElementById('stopModalScan').classList.remove('hidden');
    } catch (err) {
        modalScanning = false;
        toast('Camera error. Please use manual entry.');
    }
}

// Stop modal scanner
function stopModalScanner() {
    if (modalQrScanner && modalScanning) {
        try {
            modalQrScanner.stop().then(() => {
                modalQrScanner.clear();
                modalScanning = false;
                document.getElementById('startModalScan').classList.remove('hidden');
                document.getElementById('stopModalScan').classList.add('hidden');
            }).catch(() => {
                modalScanning = false;
                document.getElementById('startModalScan').classList.remove('hidden');
                document.getElementById('stopModalScan').classList.add('hidden');
            });
        } catch (err) {
            modalScanning = false;
            document.getElementById('startModalScan').classList.remove('hidden');
            document.getElementById('stopModalScan').classList.add('hidden');
        }
    }
}

// Search shipment by AWB
let foundShipmentId = null;
let foundShipmentAwb = null;
async function searchShipmentByAwb() {
    const awb = document.getElementById('manualAwbInput').value.trim();
    if (!awb) {
        toast('Please enter AWB number');
        return;
    }

    showLoading();
    try {
        const response = await fetch(`/scan/${awb}/`);
        const data = await response.json();
        hideLoading();

        if (data.success) {
            const shipment = data.shipment;
            foundShipmentId = shipment.id;
            foundShipmentAwb = shipment.awb_number;
            document.getElementById('foundAwb').textContent = shipment.awb_number;
            document.getElementById('foundRecipient').textContent = shipment.shipper_name + ' ‚Üí ' + shipment.recipient_name;
            document.getElementById('foundWeight').textContent = shipment.weight + ' KG';
            document.getElementById('foundStatus').textContent = 'Status: ' + shipment.status_display;
            document.getElementById('shipmentInfo').classList.remove('hidden');
        } else {
            toast('Shipment not found');
            document.getElementById('shipmentInfo').classList.add('hidden');
        }
    } catch (err) {
        hideLoading();
        toast('Search failed');
    }
}

// Select found shipment
function selectFoundShipment() {
    if (!foundShipmentId) return;
    
    // Check if already selected
    if (selectedShipments.find(s => s.id === foundShipmentId)) {
        toast('Shipment already added');
        return;
    }
    
    // Add to selected shipments
    selectedShipments.push({
        id: foundShipmentId,
        awb: foundShipmentAwb
    });
    
    updateSelectedShipmentsList();
    stopModalScanner();
    hideModal('shipmentScanModal');
    toast('‚úì Shipment added');
}

// Remove shipment from selection
function removeSelectedShipment(shipmentId) {
    selectedShipments = selectedShipments.filter(s => s.id !== shipmentId);
    updateSelectedShipmentsList();
}

// Update selected shipments list display
function updateSelectedShipmentsList() {
    const container = document.getElementById('selectedShipmentsList');
    const idsInput = document.getElementById('selectedShipmentIds');
    
    if (selectedShipments.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 italic">No shipments selected</p>';
        idsInput.value = '';
    } else {
        container.innerHTML = selectedShipments.map(s => `
            <div class="flex items-center justify-between bg-gray-100 rounded px-3 py-2">
                <span class="text-sm font-medium">${s.awb}</span>
                <button onclick="removeSelectedShipment(${s.id})" class="text-red-600 hover:text-red-800">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        `).join('');
        idsInput.value = selectedShipments.map(s => s.id).join(',');
    }
}

// Select from dropdown
function selectFromDropdown() {
    const dropdown = document.getElementById('allShipmentsDropdown');
    const selectedOption = dropdown.options[dropdown.selectedIndex];
    
    if (!selectedOption.value) return;
    
    const id = parseInt(selectedOption.value);
    const awb = selectedOption.getAttribute('data-awb');
    const recipient = selectedOption.getAttribute('data-recipient');
    const weight = selectedOption.getAttribute('data-weight');
    const status = selectedOption.getAttribute('data-status');
    
    // Show in found shipment area
    foundShipmentId = id;
    foundShipmentAwb = awb;
    document.getElementById('foundAwb').textContent = awb;
    document.getElementById('foundRecipient').textContent = recipient;
    document.getElementById('foundWeight').textContent = weight + ' KG';
    document.getElementById('foundStatus').textContent = 'Status: ' + status;
    document.getElementById('shipmentInfo').classList.remove('hidden');
}

// Create bag
async function createBag() {
    const shipmentIds = document.getElementById('selectedShipmentIds').value;
    const weight = document.getElementById('bagWeight').value;

    showLoading();
    
    try {
        const response = await fetch('/bags/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                shipment_ids: shipmentIds ? shipmentIds.split(',').map(id => parseInt(id)) : [],
                weight: weight || 0
            })
        });

        const data = await response.json();
        hideLoading();

        if (data.success) {
            hideModal('createBagModal');
            toast('‚úì Bag created successfully');
            setTimeout(() => location.reload(), 1000);
        } else {
            toast('Error: ' + data.error);
        }
    } catch (err) {
        hideLoading();
        toast('Request failed');
    }
}

// Current bag ID for status change
let currentBagId = null;
let pendingNewStatus = null;
let pendingNewStatusLabel = null;

// View bag details
async function viewBagDetails(bagId) {
    showLoading();
    currentBagId = bagId;
    
    try {
        const response = await fetch(`/bags/${bagId}/`);
        const data = await response.json();
        hideLoading();

        if (data.success) {
            const bag = data.bag;
            
            document.getElementById('viewBagNumber').textContent = bag.bag_number;
            document.getElementById('viewBagWeight').textContent = bag.weight + ' KG';
            document.getElementById('viewBagCreated').textContent = bag.created_at;
            
            // Status badge
            let statusClass = 'status-pending';
            if (bag.status === 'SEALED') statusClass = 'status-booked';
            else if (bag.status === 'DISPATCHED') statusClass = 'status-delivered';
            else if (bag.status === 'IN_MANIFEST') statusClass = 'status-transit';
            
            const badge = document.getElementById('viewBagStatus');
            badge.textContent = bag.status_display;
            badge.className = 'status-badge text-sm px-4 py-2 ' + statusClass;
            
            // Shipment
            if (bag.shipment) {
                document.getElementById('viewBagShipmentContainer').classList.remove('hidden');
                document.getElementById('viewBagShipment').textContent = bag.shipment;
                document.getElementById('codesNote').textContent = `Displaying shipment ${bag.shipment} codes`;
            } else {
                document.getElementById('viewBagShipmentContainer').classList.add('hidden');
                document.getElementById('codesNote').textContent = 'Displaying bag number codes (no shipment assigned)';
            }
            
            // Show shipment and manifest details
            const shipmentManifestInfo = document.getElementById('shipmentManifestInfo');
            const shipmentDetailSection = document.getElementById('shipmentDetailSection');
            const manifestDetailSection = document.getElementById('manifestDetailSection');
            
            if (bag.shipment_info || bag.manifest) {
                shipmentManifestInfo.classList.remove('hidden');
                
                if (bag.shipment_info) {
                    shipmentDetailSection.classList.remove('hidden');
                    document.getElementById('viewShipmentAwb').textContent = bag.shipment_info.awb_number;
                    document.getElementById('viewShipmentRecipient').textContent = `To: ${bag.shipment_info.recipient_name}`;
                    document.getElementById('viewShipmentStatus').textContent = `Status: ${bag.shipment_info.status} ‚Ä¢ ${bag.shipment_info.weight} KG`;
                } else {
                    shipmentDetailSection.classList.add('hidden');
                }
                
                if (bag.manifest) {
                    manifestDetailSection.classList.remove('hidden');
                    document.getElementById('viewManifestNum').textContent = bag.manifest.manifest_number;
                    document.getElementById('viewManifestFlight').textContent = `Flight: ${bag.manifest.flight_number}`;
                    document.getElementById('viewManifestStatus').textContent = `${bag.manifest.status} ‚Ä¢ ${bag.manifest.departure_date}`;
                } else {
                    manifestDetailSection.classList.add('hidden');
                }
            } else {
                shipmentManifestInfo.classList.add('hidden');
            }
            
            // Status action buttons
            renderStatusButtons(bag.status);
            
            // QR & Barcode
            document.getElementById('viewBagQR').src = bag.qr_code;
            document.getElementById('viewBagBarcode').src = bag.barcode;
            
            showModal('viewBagModal');
        } else {
            toast('Error loading bag details');
        }
    } catch (err) {
        hideLoading();
        toast('Request failed');
    }
}

// Render status change buttons based on current status
function renderStatusButtons(currentStatus) {
    const statusFlow = {
        'OPEN': [
            { status: 'SEALED', label: 'Seal Bag', icon: 'lock' }
        ],
        'SEALED': [
            { status: 'IN_MANIFEST', label: 'Add to Manifest', icon: 'document' }
        ],
        'IN_MANIFEST': [
            { status: 'DISPATCHED', label: 'Mark as Dispatched', icon: 'truck' }
        ],
        'DISPATCHED': []
    };
    
    const buttons = statusFlow[currentStatus] || [];
    const container = document.getElementById('statusActionBtns');
    
    if (buttons.length === 0) {
        document.getElementById('statusActionsContainer').classList.add('hidden');
        return;
    }
    
    document.getElementById('statusActionsContainer').classList.remove('hidden');
    
    const icons = {
        'lock': `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
        </svg>`,
        'document': `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>`,
        'truck': `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"></path>
        </svg>`
    };
    
    container.innerHTML = buttons.map(btn => `
        <button onclick="confirmStatusChange('${btn.status}', '${btn.label}')" class="w-full bg-white border-2 border-black hover:bg-black text-black hover:text-white font-medium py-3.5 px-4 rounded-xl transition-all duration-200 flex items-center justify-start gap-3 text-left group">
            <div class="w-10 h-10 bg-black group-hover:bg-white text-white group-hover:text-black rounded-lg flex items-center justify-center flex-shrink-0 transition-colors">
                ${icons[btn.icon]}
            </div>
            <span class="text-sm font-semibold">${btn.label}</span>
        </button>
    `).join('');
}

// Show confirmation modal
function confirmStatusChange(newStatus, label) {
    pendingNewStatus = newStatus;
    pendingNewStatusLabel = label;
    document.getElementById('confirmNewStatus').textContent = label;
    showModal('confirmStatusModal');
}

// Confirm and execute status change
document.getElementById('confirmStatusBtn').onclick = async () => {
    hideModal('confirmStatusModal');
    showLoading();
    
    try {
        const response = await fetch(`/bags/${currentBagId}/status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                status: pendingNewStatus
            })
        });
        
        const data = await response.json();
        hideLoading();
        
        if (data.success) {
            toast('‚úì Status updated successfully');
            // Reload bag details
            setTimeout(() => viewBagDetails(currentBagId), 1000);
        } else {
            toast('Error: ' + data.error);
        }
    } catch (err) {
        hideLoading();
        toast('Request failed');
    }
};
</script>

<script>
// MAWB Search functionality
let currentManifestId = null;
let pendingManifestStatus = null;

// Show MAWB search modal
function showMAWBSearchModal() {
    document.getElementById('mawbSearchInput').value = '';
    document.getElementById('mawbSearchResults').classList.add('hidden');
    document.getElementById('mawbNotFound').classList.add('hidden');
    currentManifestId = null;
    showModal('mawbSearchModal');
}

// Search manifest by MAWB
async function searchByMAWB() {
    const mawb = document.getElementById('mawbSearchInput').value.trim();
    if (!mawb) {
        toast('Please enter MAWB number');
        return;
    }

    showLoading();
    try {
        const response = await fetch(`/manifests/search/?mawb=${encodeURIComponent(mawb)}`);
        const data = await response.json();
        hideLoading();

        if (data.success && data.manifest) {
            displayManifestSearchResult(data.manifest);
            document.getElementById('mawbSearchResults').classList.remove('hidden');
            document.getElementById('mawbNotFound').classList.add('hidden');
        } else {
            document.getElementById('mawbSearchResults').classList.add('hidden');
            document.getElementById('mawbNotFound').classList.remove('hidden');
        }
    } catch (err) {
        hideLoading();
        toast('Search failed');
        document.getElementById('mawbSearchResults').classList.add('hidden');
        document.getElementById('mawbNotFound').classList.remove('hidden');
    }
}

// Display manifest search result
function displayManifestSearchResult(manifest) {
    currentManifestId = manifest.id;
    
    document.getElementById('mawbManifestNumber').textContent = manifest.manifest_number;
    document.getElementById('mawbFlight').textContent = manifest.flight_number;
    document.getElementById('mawbNumber').textContent = manifest.mawb_number || 'N/A';
    document.getElementById('mawbDeparture').textContent = manifest.departure_date;
    document.getElementById('mawbTotalBags').textContent = manifest.total_bags || 0;
    
    // Status badge
    let statusClass = 'status-pending';
    if (manifest.status === 'FINALIZED') statusClass = 'status-booked';
    else if (manifest.status === 'DEPARTED') statusClass = 'status-transit';
    else if (manifest.status === 'ARRIVED') statusClass = 'status-delivered';
    
    const badge = document.getElementById('mawbManifestStatus');
    badge.textContent = manifest.status;
    badge.className = 'status-badge text-sm px-4 py-2 ' + statusClass;
    
    // View details link
    document.getElementById('mawbViewDetailsLink').href = `/manifests/${manifest.id}/`;
    
    // Render status update buttons
    renderManifestStatusButtons(manifest.status);
}

// Render manifest status update buttons
function renderManifestStatusButtons(currentStatus) {
    const container = document.getElementById('mawbActionButtons');
    const actionsContainer = document.getElementById('mawbStatusActions');
    
    const buttons = [];
    
    if (currentStatus === 'FINALIZED') {
        buttons.push({
            status: 'DEPARTED',
            label: 'Mark as Departed',
            description: 'Update all shipments to HANDED_TO_AIRLINE',
            icon: 'plane-departure'
        });
    } else if (currentStatus === 'DEPARTED') {
        buttons.push({
            status: 'IN_TRANSIT_TO_HONGKONG',
            label: 'Mark as In Transit',
            description: 'Update all shipments to IN_TRANSIT_TO_HK',
            icon: 'plane'
        });
    }
    
    if (buttons.length === 0) {
        actionsContainer.classList.add('hidden');
        return;
    }
    
    actionsContainer.classList.remove('hidden');
    
    const icons = {
        'plane-departure': `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
        </svg>`,
        'plane': `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
        </svg>`
    };
    
    container.innerHTML = buttons.map(btn => `
        <button onclick="confirmManifestStatusUpdate('${btn.status}', '${btn.label}')" class="w-full bg-white border-2 border-black hover:bg-black text-black hover:text-white font-medium py-3.5 px-4 rounded-xl transition-all duration-200 flex items-start gap-3 text-left group">
            <div class="w-10 h-10 bg-black group-hover:bg-white text-white group-hover:text-black rounded-lg flex items-center justify-center flex-shrink-0 transition-colors">
                ${icons[btn.icon]}
            </div>
            <div class="flex-1">
                <p class="text-sm font-semibold">${btn.label}</p>
                <p class="text-xs text-gray-600 group-hover:text-gray-300 mt-0.5">${btn.description}</p>
            </div>
        </button>
    `).join('');
}

// Confirm manifest status update
function confirmManifestStatusUpdate(newStatus, label) {
    pendingManifestStatus = newStatus;
    document.getElementById('confirmManifestNewStatus').textContent = label;
    showModal('confirmManifestStatusModal');
}

// Execute manifest status update
document.getElementById('confirmManifestStatusBtn').onclick = async () => {
    if (!currentManifestId || !pendingManifestStatus) return;
    
    hideModal('confirmManifestStatusModal');
    showLoading();
    
    try {
        const response = await fetch(`/manifests/${currentManifestId}/status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                status: pendingManifestStatus
            })
        });
        
        const data = await response.json();
        hideLoading();
        
        if (data.success) {
            toast('‚úì Manifest status updated successfully');
            // Refresh the search results
            setTimeout(() => searchByMAWB(), 1000);
        } else {
            toast('Error: ' + (data.error || 'Failed to update status'));
        }
    } catch (err) {
        hideLoading();
        toast('Request failed');
    }
};
</script>
{% endblock %}
